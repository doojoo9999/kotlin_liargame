const lighthouse = require('lighthouse');
const chromeLauncher = require('chrome-launcher');
const fs = require('fs');
const path = require('path');

// Lighthouse Í∞êÏÇ¨ ÎèÑÍµ¨
class LighthouseAuditor {
  constructor() {
    this.auditResults = {};
  }

  async runAudit(url = 'http://localhost:5173', options = {}) {
    console.log(`üîç Lighthouse Í∞êÏÇ¨ ÏãúÏûë: ${url}`);

    const chrome = await chromeLauncher.launch({
      chromeFlags: ['--headless', '--no-sandbox', '--disable-dev-shm-usage']
    });

    const lighthouseOptions = {
      logLevel: 'info',
      output: 'json',
      onlyCategories: ['performance', 'accessibility', 'best-practices', 'seo'],
      port: chrome.port,
      ...options
    };

    try {
      const runnerResult = await lighthouse(url, lighthouseOptions);

      await chrome.kill();

      const auditResult = this.processLighthouseResults(runnerResult);
      this.auditResults[url] = auditResult;

      return auditResult;
    } catch (error) {
      await chrome.kill();
      throw error;
    }
  }

  async runMultipleAudits() {
    console.log('üîÑ Îã§Ï§ë ÌéòÏù¥ÏßÄ Lighthouse Í∞êÏÇ¨ Ïã§Ìñâ...');

    const urls = [
      { name: 'Main Demo', url: 'http://localhost:5173' },
      { name: 'Phase 4 Demo', url: 'http://localhost:5173/phase4-demo.html' }
    ];

    const results = {};

    for (const { name, url } of urls) {
      console.log(`\nüìÑ ${name} Í∞êÏÇ¨ Ï§ë...`);

      try {
        const result = await this.runAudit(url);
        results[name] = result;

        console.log(`‚úÖ ${name} Í∞êÏÇ¨ ÏôÑÎ£å`);
        this.printAuditSummary(name, result);
      } catch (error) {
        console.error(`‚ùå ${name} Í∞êÏÇ¨ Ïã§Ìå®:`, error.message);
        results[name] = { error: error.message };
      }
    }

    return results;
  }

  processLighthouseResults(runnerResult) {
    const lhr = runnerResult.lhr;

    const categories = {};
    Object.keys(lhr.categories).forEach(key => {
      const category = lhr.categories[key];
      categories[key] = {
        score: Math.round(category.score * 100),
        title: category.title,
        description: category.description
      };
    });

    const metrics = {
      'first-contentful-paint': this.getMetricValue(lhr, 'first-contentful-paint'),
      'largest-contentful-paint': this.getMetricValue(lhr, 'largest-contentful-paint'),
      'first-meaningful-paint': this.getMetricValue(lhr, 'first-meaningful-paint'),
      'speed-index': this.getMetricValue(lhr, 'speed-index'),
      'interactive': this.getMetricValue(lhr, 'interactive'),
      'total-blocking-time': this.getMetricValue(lhr, 'total-blocking-time'),
      'cumulative-layout-shift': this.getMetricValue(lhr, 'cumulative-layout-shift')
    };

    // Ï£ºÏöî Í∞úÏÑ†ÏÇ¨Ìï≠ Ï∂îÏ∂ú
    const opportunities = lhr.audits ? Object.values(lhr.audits)
      .filter(audit => audit.score !== null && audit.score < 0.9 && audit.details)
      .map(audit => ({
        id: audit.id,
        title: audit.title,
        description: audit.description,
        score: Math.round(audit.score * 100),
        savings: audit.details.overallSavingsMs || 0
      }))
      .sort((a, b) => b.savings - a.savings)
      .slice(0, 5) : [];

    return {
      categories,
      metrics,
      opportunities,
      timestamp: new Date().toISOString(),
      finalUrl: lhr.finalUrl
    };
  }

  getMetricValue(lhr, metricId) {
    const audit = lhr.audits[metricId];
    if (!audit) return null;

    return {
      value: audit.numericValue,
      displayValue: audit.displayValue,
      score: audit.score ? Math.round(audit.score * 100) : null
    };
  }

  printAuditSummary(name, result) {
    if (result.error) {
      console.log(`‚ùå ${name}: Í∞êÏÇ¨ Ïã§Ìå®`);
      return;
    }

    console.log(`\nüìä ${name} Í∞êÏÇ¨ Í≤∞Í≥º:`);

    // Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†êÏàò
    Object.entries(result.categories).forEach(([key, category]) => {
      const emoji = this.getScoreEmoji(category.score);
      console.log(`${emoji} ${category.title}: ${category.score}/100`);
    });

    // ÌïµÏã¨ ÏßÄÌëú
    console.log('\n‚ö° ÌïµÏã¨ ÏÑ±Îä• ÏßÄÌëú:');
    if (result.metrics['first-contentful-paint']) {
      console.log(`FCP: ${result.metrics['first-contentful-paint'].displayValue}`);
    }
    if (result.metrics['largest-contentful-paint']) {
      console.log(`LCP: ${result.metrics['largest-contentful-paint'].displayValue}`);
    }
    if (result.metrics['total-blocking-time']) {
      console.log(`TBT: ${result.metrics['total-blocking-time'].displayValue}`);
    }
    if (result.metrics['cumulative-layout-shift']) {
      console.log(`CLS: ${result.metrics['cumulative-layout-shift'].displayValue}`);
    }

    // Í∞úÏÑ† Í∏∞Ìöå
    if (result.opportunities.length > 0) {
      console.log('\nüí° Ï£ºÏöî Í∞úÏÑ† Í∏∞Ìöå:');
      result.opportunities.slice(0, 3).forEach((opp, index) => {
        console.log(`${index + 1}. ${opp.title} (${opp.savings}ms Ï†àÏïΩ Í∞ÄÎä•)`);
      });
    }
  }

  getScoreEmoji(score) {
    if (score >= 90) return 'üü¢';
    if (score >= 70) return 'üü°';
    return 'üî¥';
  }

  async generateAuditReport(results) {
    console.log('\nüìã Ï¢ÖÌï© Í∞êÏÇ¨ Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ± Ï§ë...');

    const report = {
      timestamp: new Date().toISOString(),
      summary: this.generateSummary(results),
      details: results,
      recommendations: this.generateRecommendations(results)
    };

    // HTML Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ±
    const htmlReport = this.generateHTMLReport(report);
    const htmlPath = path.join(__dirname, '../lighthouse-report.html');
    fs.writeFileSync(htmlPath, htmlReport);

    // JSON Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ±
    const jsonPath = path.join(__dirname, '../lighthouse-report.json');
    fs.writeFileSync(jsonPath, JSON.stringify(report, null, 2));

    console.log(`üìä HTML Î¶¨Ìè¨Ìä∏: ${htmlPath}`);
    console.log(`üìä JSON Î¶¨Ìè¨Ìä∏: ${jsonPath}`);

    return report;
  }

  generateSummary(results) {
    const summary = {
      totalPages: Object.keys(results).length,
      averageScores: {},
      bestPerforming: null,
      needsImprovement: []
    };

    const validResults = Object.entries(results).filter(([_, result]) => !result.error);

    if (validResults.length === 0) return summary;

    // ÌèâÍ∑† Ï†êÏàò Í≥ÑÏÇ∞
    const categories = ['performance', 'accessibility', 'best-practices', 'seo'];
    categories.forEach(category => {
      const scores = validResults
        .map(([_, result]) => result.categories[category]?.score || 0)
        .filter(score => score > 0);

      summary.averageScores[category] = scores.length > 0
        ? Math.round(scores.reduce((sum, score) => sum + score, 0) / scores.length)
        : 0;
    });

    // ÏµúÍ≥† ÏÑ±Îä• ÌéòÏù¥ÏßÄ
    let bestScore = 0;
    validResults.forEach(([name, result]) => {
      const avgScore = Object.values(result.categories)
        .reduce((sum, cat) => sum + cat.score, 0) / Object.keys(result.categories).length;

      if (avgScore > bestScore) {
        bestScore = avgScore;
        summary.bestPerforming = name;
      }
    });

    // Í∞úÏÑ† ÌïÑÏöî ÌéòÏù¥ÏßÄ
    validResults.forEach(([name, result]) => {
      const issues = Object.entries(result.categories)
        .filter(([_, cat]) => cat.score < 70)
        .map(([key, cat]) => `${cat.title}: ${cat.score}/100`);

      if (issues.length > 0) {
        summary.needsImprovement.push({ page: name, issues });
      }
    });

    return summary;
  }

  generateRecommendations(results) {
    const recommendations = [];

    Object.entries(results).forEach(([name, result]) => {
      if (result.error) return;

      // ÏÑ±Îä• Í∞úÏÑ†
      if (result.categories.performance?.score < 80) {
        recommendations.push({
          category: 'Performance',
          priority: 'High',
          page: name,
          suggestion: 'Ïù¥ÎØ∏ÏßÄ ÏµúÏ†ÅÌôî, ÏΩîÎìú Ïä§ÌîåÎ¶¨ÌåÖ, Ï∫êÏã± Ï†ÑÎûµ Í∞úÏÑ†'
        });
      }

      // Ï†ëÍ∑ºÏÑ± Í∞úÏÑ†
      if (result.categories.accessibility?.score < 90) {
        recommendations.push({
          category: 'Accessibility',
          priority: 'High',
          page: name,
          suggestion: 'ARIA ÏÜçÏÑ± Î≥¥ÏôÑ, ÏÉâÏÉÅ ÎåÄÎπÑ Í∞úÏÑ†, ÌÇ§Î≥¥Îìú ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Í∞ïÌôî'
        });
      }

      // Î≤†Ïä§Ìä∏ ÌîÑÎûôÌã∞Ïä§
      if (result.categories['best-practices']?.score < 85) {
        recommendations.push({
          category: 'Best Practices',
          priority: 'Medium',
          page: name,
          suggestion: 'Î≥¥Ïïà Ìó§Îçî Ï∂îÍ∞Ä, ÏµúÏã† API ÏÇ¨Ïö©, ÏΩòÏÜî ÏóêÎü¨ Ìï¥Í≤∞'
        });
      }
    });

    return recommendations;
  }

  generateHTMLReport(report) {
    return `
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lighthouse Í∞êÏÇ¨ Î¶¨Ìè¨Ìä∏</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #333; }
        .summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .metric { background: #f8f9fa; padding: 20px; border-radius: 6px; text-align: center; }
        .score { font-size: 2em; font-weight: bold; margin: 10px 0; }
        .score.good { color: #0cce6b; }
        .score.average { color: #ffa400; }
        .score.poor { color: #ff4e42; }
        .recommendations { background: #fff3cd; padding: 15px; border-radius: 6px; margin: 20px 0; }
        .page-results { margin: 30px 0; padding: 20px; border: 1px solid #ddd; border-radius: 6px; }
        .opportunities { background: #e7f3ff; padding: 15px; border-radius: 6px; margin: 10px 0; }
        .timestamp { color: #666; font-size: 0.9em; text-align: right; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Phase 5 Lighthouse Í∞êÏÇ¨ Î¶¨Ìè¨Ìä∏</h1>
        <div class="timestamp">ÏÉùÏÑ±Ïùº: ${new Date(report.timestamp).toLocaleString('ko-KR')}</div>
        
        <h2>üìä Ï†ÑÏ≤¥ ÏöîÏïΩ</h2>
        <div class="summary">
            <div class="metric">
                <div>ÏÑ±Îä•</div>
                <div class="score ${this.getScoreClass(report.summary.averageScores.performance)}">${report.summary.averageScores.performance}</div>
            </div>
            <div class="metric">
                <div>Ï†ëÍ∑ºÏÑ±</div>
                <div class="score ${this.getScoreClass(report.summary.averageScores.accessibility)}">${report.summary.averageScores.accessibility}</div>
            </div>
            <div class="metric">
                <div>Î™®Î≤î ÏÇ¨Î°Ä</div>
                <div class="score ${this.getScoreClass(report.summary.averageScores['best-practices'])}">${report.summary.averageScores['best-practices']}</div>
            </div>
            <div class="metric">
                <div>SEO</div>
                <div class="score ${this.getScoreClass(report.summary.averageScores.seo)}">${report.summary.averageScores.seo}</div>
            </div>
        </div>

        ${report.summary.bestPerforming ? `<p><strong>üèÜ ÏµúÍ≥† ÏÑ±Îä• ÌéòÏù¥ÏßÄ:</strong> ${report.summary.bestPerforming}</p>` : ''}

        <h2>üí° Í∞úÏÑ† Í∂åÏû•ÏÇ¨Ìï≠</h2>
        <div class="recommendations">
            ${report.recommendations.map(rec => 
                `<div><strong>${rec.category}</strong> (${rec.priority}): ${rec.suggestion}</div>`
            ).join('')}
        </div>

        <h2>üìÑ ÌéòÏù¥ÏßÄÎ≥Ñ ÏÉÅÏÑ∏ Í≤∞Í≥º</h2>
        ${Object.entries(report.details).map(([name, result]) => 
            result.error ? 
                `<div class="page-results"><h3>${name}</h3><p style="color: red;">‚ùå Í∞êÏÇ¨ Ïã§Ìå®: ${result.error}</p></div>` :
                `<div class="page-results">
                    <h3>${name}</h3>
                    <div class="summary">
                        ${Object.entries(result.categories).map(([key, cat]) => 
                            `<div class="metric">
                                <div>${cat.title}</div>
                                <div class="score ${this.getScoreClass(cat.score)}">${cat.score}</div>
                            </div>`
                        ).join('')}
                    </div>
                    ${result.opportunities.length > 0 ? 
                        `<div class="opportunities">
                            <h4>üîß Í∞úÏÑ† Í∏∞Ìöå</h4>
                            ${result.opportunities.map(opp => 
                                `<div>‚Ä¢ ${opp.title} (${opp.savings}ms Ï†àÏïΩ)</div>`
                            ).join('')}
                        </div>` : ''}
                </div>`
        ).join('')}
    </div>
</body>
</html>`;
  }

  getScoreClass(score) {
    if (score >= 90) return 'good';
    if (score >= 70) return 'average';
    return 'poor';
  }
}

// Ïã§Ìñâ Ìï®Ïàò
async function runLighthouseAudit() {
  console.log('üîç Lighthouse Í∞êÏÇ¨ ÏãúÏûë\n');

  const auditor = new LighthouseAuditor();

  try {
    console.log('‚ö†Ô∏è  Ï£ºÏùò: Í∞êÏÇ¨Î•º Ïã§ÌñâÌïòÍ∏∞ Ï†ÑÏóê Í∞úÎ∞ú ÏÑúÎ≤ÑÍ∞Ä Ïã§Ìñâ Ï§ëÏù∏ÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî (npm run dev)');
    console.log('‚è≥ ÏÑúÎ≤Ñ ÏãúÏûë ÎåÄÍ∏∞ Ï§ë... (5Ï¥à)');

    await new Promise(resolve => setTimeout(resolve, 5000));

    const results = await auditor.runMultipleAudits();
    const report = await auditor.generateAuditReport(results);

    console.log('\n‚úÖ Lighthouse Í∞êÏÇ¨ ÏôÑÎ£å!');
    console.log('üìä Î¶¨Ìè¨Ìä∏ ÌååÏùºÏù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.');

    return report;
  } catch (error) {
    console.error('‚ùå Lighthouse Í∞êÏÇ¨ Ïã§Ìå®:', error);
    process.exit(1);
  }
}

if (require.main === module) {
  runLighthouseAudit();
}

module.exports = { LighthouseAuditor };
